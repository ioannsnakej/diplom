.ssh_setup: &ssh_setup
  - apk update && apk add openssh-client rsync bash --no-cache
  - eval "$(ssh-agent -s)"
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - cat $SSH_KEY > ~/.ssh/id_ed25519
  - chmod 600 ~/.ssh/id_ed25519
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

.terraform-init: &terraform-init
  - terraform version
  - |
    cat > ~/.terraformrc << 'EOF'
    provider_installation {
      network_mirror {
        url = "https://terraform-mirror.yandexcloud.net/"
        include = ["registry.terraform.io/*/*"]
      }
      direct {
        exclude = ["registry.terraform.io/*/*"]
      }
    }
    EOF
  - terraform -chdir=$DIR init -backend-config="access_key=$YC_ACCESS_KEY" -backend-config="secret_key=$YC_SECRET_KEY"

.yc-init: &yc-init
  - curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i ./ -n 
  - cp ./bin/yc /usr/bin
  - yc config profile create sa-tf
  - cat "$SA_KEY" > sa-key.json 
  - yc config set service-account-key sa-key.json
  - export YC_TOKEN=$(yc iam create-token)

variables:
  DIR: "terraform"
  PLAN_FILE: "tfplan-${CI_COMMIT_SHORT_SHA}"
  API_URL: "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
  TF_VAR_yc_token: $YC_TOKEN
  TF_VAR_folder_id: $YC_FOLDER_ID

linter:job:
  stage: lint-tf
  image:
    name: ghcr.io/terraform-linters/tflint
    entrypoint:
    - "/usr/bin/env"
    - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  script:
    - cd ${DIR}
    - tflint --init
    - tflint
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[infra\]/'       
  tags:
    - runner

validate:job:
  stage: validate
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - *ssh_setup
    - *terraform-init
  script:
    - terraform -chdir=$DIR validate
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[infra\]/'  
  tags:
    - runner

plan:job:
  stage: plan
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - apk update && apk add ansible coreutils bash curl
    - *ssh_setup
    - *terraform-init
    - *yc-init
  script:
    - terraform -chdir=$DIR plan -out ${PLAN_FILE}
  artifacts:
    paths:
      - ${DIR}/${PLAN_FILE}
      - .terraform.lock.hcl
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[infra\]/'  
  tags:
    - runner

apply:job:
  stage: apply
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  dependencies: ["plan:job"]
  before_script:
    - apk update && apk add ansible coreutils bash curl
    - *ssh_setup
    - *terraform-init
    - *yc-init
  script:
    - terraform -chdir=$DIR apply -input=false ${PLAN_FILE}
    - terraform output -raw instance_ip > ${DIR}/instance_ip.txt
  artifacts:
    paths:
      - ${DIR}/instance_ip.txt
  when: manual
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[infra\]/'       
  tags:
    - runner

destroy:job:
  stage: destroy
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - apk update && apk add ansible coreutils bash curl
    - *ssh_setup
    - *terraform-init
    - *yc-init
  script:
    - terraform destroy -auto-approve
  when: manual
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[destroy\]/'  
  tags:
    - runner