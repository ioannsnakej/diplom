.terraform-init: &terraform-init
  - terraform version
  - cp "$SA_KEY" $TF_ROOT/sa-key.json
  - |
    cat > ~/.terraformrc << 'EOF'
    provider_installation {
      network_mirror {
        url = "https://terraform-mirror.yandexcloud.net/"
        include = ["registry.terraform.io/*/*"]
      }
      direct {
        exclude = ["registry.terraform.io/*/*"]
      }
    }
    EOF
  - terraform -chdir=$TF_ROOT init -backend-config="access_key=$YC_ACCESS_KEY" -backend-config="secret_key=$YC_SECRET_KEY"

.ssh_setup: &ssh_setup
  - apk update && apk add openssh-client rsync bash --no-cache
  - eval "$(ssh-agent -s)"
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - cat $SSH_KEY > ~/.ssh/id_ed25519
  - chmod 600 ~/.ssh/id_ed25519
  - ssh-add ~/.ssh/id_ed25519 
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

.notify: &notify
  - |
    if [ "$CI_JOB_STATUS" == "success" ]; then
      EMOJI="✅"
      STATUS="success"
     else
      EMOJI="❌"
      STATUS="failed"
    fi
    TEXT="${EMOJI} Job ${CI_JOB_NAME} ${STATUS}"
    [ -n "$PUB_IP" ] && TEXT="${TEXT}. VM ${PUB_IP} is ready."
    curl -X POST ${API_URL} \
      -d chat_id=$TELEGRAM_CHAT_ID \
      -d text="$TEXT" || true

variables:
  TF_ROOT: "terraform"
  PLAN_FILE: "deploy.tfplan-${CI_COMMIT_SHORT_SHA}"
  API_URL: "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
  MODE: $[[ inputs.mode ]]

linter:job:
  stage: lint-tf
  image:
    name: ghcr.io/terraform-linters/tflint
    entrypoint:
    - "/usr/bin/env"
    - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  script:
    - cd ${TF_ROOT}
    - tflint --init
    - tflint
  allow_failure: true
  rules:
    - if: '$MODE == "apply"'    
  tags:
    - runner

validate:job:
  stage: validate
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - *terraform-init
  script:
    - terraform -chdir=$TF_ROOT validate
  rules:
    - if: '$MODE == "apply"' 
  tags:
    - runner

plan:job:
  stage: plan
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - apk update && apk add ansible coreutils bash curl
    - *terraform-init
  variables:
    TF_VAR_sa_key_file: "sa-key.json"
  script:
    - terraform -chdir=$TF_ROOT plan -out ${PLAN_FILE}
  after_script:
    - *notify
  artifacts:
    paths:
      - ${TF_ROOT}/${PLAN_FILE}
    expire_in: 1 hour
  rules:
    - if: '$MODE == "apply"' 
  tags:
    - runner

apply:job:
  stage: apply
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - apk update && apk add ansible coreutils bash curl
    - *ssh_setup
    - *terraform-init
  variables:
    TF_VAR_sa_key_file: "sa-key.json"
  script:
    - terraform -chdir=$TF_ROOT apply -input=false ${PLAN_FILE}
    - terraform -chdir=$TF_ROOT output -raw instance_ip > instance_ip.txt
    - echo "PUB_IP=$(cat instance_ip.txt)" > deploy.env
  artifacts:
    paths:
      - instance_ip.txt
    reports:
      dotenv:
        - deploy.env
  after_script:
    - PUB_IP=$(cat instance_ip.txt)
    - *notify
  rules:
    - if: '$MODE == "apply"' 
      when: manual      
  tags:
    - runner

destroy:job:
  stage: destroy
  image:
    name: hashicorp/terraform:1.6
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - apk update && apk add curl bash --no-cache
    - *terraform-init
  variables:
    TF_VAR_sa_key_file: "sa-key.json"
  script:
    - terraform -chdir=$TF_ROOT destroy -auto-approve
  after_script:
    - *notify
  rules:
    - if: '$MODE == "destroy"' 
      when: manual
  tags:
    - runner

trigger-deploy:job:
  stage: run-deploy
  trigger:
    include:
      - local: 'deployment/deploy.yml'
  variables:
    HOST: $PUB_IP
  rules:
    - if: '$MODE == "apply"'