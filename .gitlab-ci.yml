spec:
  inputs:
    mode:
      description: "Choose DEPLOY_MODE: deploy or rollback"
      type: string
      default: "deploy"
      options: ["deploy", "rollback", "apply", "destroy"]
    tag:
      description: "Give me tag for rollback"
      type: string
      default: ""
---

.ssh_setup:
  - apk update && apk add openssh-client rsync bash --no-cache
  - eval "$(ssh-agent -s)"
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - cat $SSH_KEY > ~/.ssh/id_ed25519
  - chmod 600 ~/.ssh/id_ed25519
  - ssh-add ~/.ssh/id_ed25519 
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

variables:
  TAG: $[[ inputs.tag ]]
  DEPLOY_MODE: $[[ inputs.mode ]]

include:
  - local: 'deployment/infra.yml'
  - local: 'deployment/deploy.yml'